<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hidden‑Number Voting</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center pt-10">
  <!-- ───── Name picker modal ───── -->
  <div id="nameModal" class="fixed inset-0 flex items-center justify-center bg-black/50">
    <div class="bg-white rounded p-6 w-80 shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Choose your name</h2>
      <select id="nameSelect" class="border w-full mb-4 p-2">
        <option value="" disabled selected>Select…</option>
        <option>Jalia</option><option>Lydia</option><option>Florence</option>
        <option>Aloysius</option><option>Christian</option><option>Alice</option>
      </select>
      <button id="nameBtn" class="bg-blue-600 text-white w-full py-2 rounded">Enter</button>
      <p id="nameErr" class="text-red-600 mt-2 hidden"></p>
    </div>
  </div>

  <!-- ───── Main UI ───── -->
  <h1 class="text-3xl font-bold mb-6">Hidden‑Number Voting</h1>

  <div id="numbers" class="grid grid-cols-3 gap-4"></div>

  <p id="info" class="mt-6 text-lg"></p>

  <section class="mt-8">
    <h2 class="text-xl font-semibold mb-2">Voters</h2>
    <ul id="voterList" class="list-disc pl-6"></ul>
  </section>

  <section id="resultsWrap" class="mt-8 hidden">
    <h2 class="text-xl font-semibold mb-2">Selections</h2>
    <ul id="results" class="list-disc pl-6"></ul>
  </section>

<script>
  const API = '/.netlify/functions';
  const voterNames = ['Jalia','Lydia','Florence','Aloysius','Christian','Alice'];
  let currentName = null;

  // ---------- helpers ----------
  const qs = sel => document.querySelector(sel);
  const ce = (tag, cls='', txt='') => {
    const e = document.createElement(tag);
    if (cls) e.className = cls;
    if (txt) e.textContent = txt;
    return e;
  };

  // ---------- modal logic ----------
  qs('#nameBtn').onclick = () => {
    const name = qs('#nameSelect').value;
    if (!voterNames.includes(name)) {
      qs('#nameErr').textContent = 'Please select your exact name.';
      qs('#nameErr').classList.remove('hidden');
      return;
    }
    currentName = name;
    qs('#nameModal').classList.add('hidden');
    render();               // initial state fetch / poll begins
  };

  // ---------- polling ----------
  async function fetchState() {
    const r = await fetch(`${API}/state`);
    if (!r.ok) throw new Error('state fetch failed');
    return r.json();
  }

  async function castVote(num) {
    const rq = {
      method : 'POST',
      headers: { 'Content-Type':'application/json' },
      body   : JSON.stringify({ name: currentName, number: num })
    };
    const r = await fetch(`${API}/vote`, rq);
    const d = await r.json();
    if (!r.ok) {
      alert(d.error || 'Vote failed');
    }
  }

  // ---------- UI render ----------
  async function render() {
    const data = await fetchState();

    // number buttons – render once
    if (!qs('#numbers').hasChildNodes()) {
      for (let i = 1; i <= 6; i++) {
        const b = ce('button',
          'bg-blue-500 text-white font-bold py-2 rounded w-20 h-12', '?');
        b.id = `btn-${i}`;
        b.onclick = () => castVote(i).then(render);
        qs('#numbers').appendChild(b);
      }
    }

    // update buttons
    for (let i = 1; i <= 6; i++) {
      const btn = qs(`#btn-${i}`);
      const takenBy = data.numbers[i];
      btn.textContent = takenBy ? i : '?';
      btn.disabled = Boolean(takenBy) || data.voters[currentName]?.has_voted;
      btn.classList.toggle('bg-gray-400', Boolean(takenBy));
      btn.classList.toggle('cursor-not-allowed', btn.disabled);
    }

    // voter list
    const vList = qs('#voterList'); vList.innerHTML = '';
    voterNames.forEach(n => {
      const li = ce('li', '', n);
      if (data.voters[n]?.has_voted) li.classList.add('line-through','text-gray-500');
      vList.appendChild(li);
    });

    // info text
    const remaining = 6 - Object.keys(data.numbers).length;
    qs('#info').textContent =
      remaining ? `${remaining} vote${remaining>1?'s':''} remaining…`
                : 'All votes cast!';

    // final results
    if (data.all_voted) {
      qs('#resultsWrap').classList.remove('hidden');
      const res = qs('#results'); res.innerHTML='';
      Object.entries(data.numbers).sort(([a],[b])=>a-b)
        .forEach(([num,name]) => res.appendChild(
          ce('li','', `${name} picked number ${num}`)
        ));
    }
  }

  // continuous polling (every 4 s) once name chosen
  setInterval(() => currentName && render(), 4000);
</script>
</body>
</html>
